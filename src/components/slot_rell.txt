import { useState, useEffect, useRef } from 'react';

function SlotRell() {
  // á€‚á€­á€™á€ºá€¸á€¡á€á€¼á€±á€¡á€”á€± (Game State)
  const [walletBalance, setWalletBalance] = useState(1000); // á€€á€”á€¦á€¸ á€œá€€á€ºá€€á€»á€”á€ºá€„á€½á€±
  const [betAmount, setBetAmount] = useState(10);
  const [selectedDigit, setSelectedDigit] = useState(null); // á€€á€…á€¬á€¸á€á€™á€¬á€¸ á€›á€½á€±á€¸á€á€»á€šá€ºá€á€±á€¬ á€‚á€á€”á€ºá€¸
  const [resultDigit, setResultDigit] = useState(null); // á€”á€±á€¬á€€á€ºá€†á€¯á€¶á€¸ á€•á€±á€«á€ºá€œá€¬á€á€±á€¬ á€‚á€á€”á€ºá€¸
  const [isSpinning, setIsSpinning] = useState(false); // á€œá€¾á€Šá€·á€ºá€”á€±á€á€±á€¬ Animation á€”á€¾á€„á€·á€º Loading á€€á€­á€¯ á€‘á€­á€”á€ºá€¸á€á€»á€¯á€•á€ºá€á€Šá€º
  const [message, setMessage] = useState(''); // á€¡á€”á€­á€¯á€„á€º/á€¡á€›á€¾á€¯á€¶á€¸/á€¡á€™á€¾á€¬á€¸ á€™á€€á€ºá€†á€±á€·á€á€»á€ºá€™á€»á€¬á€¸

  // Animation á€¡á€á€¼á€±á€¡á€”á€± (Animation State)
  const [spinAnimationDigit, setSpinAnimationDigit] = useState(null);
  const spinIntervalRef = useRef(null); // Interval ID á€€á€­á€¯ á€á€­á€™á€ºá€¸á€†á€Šá€ºá€¸á€›á€”á€º Ref

  // Payout á€€á€­á€”á€ºá€¸á€á€±á€™á€»á€¬á€¸ (Backend á€á€­á€¯á€·á€™á€Ÿá€¯á€á€º Config á€á€­á€¯á€· á€›á€½á€¾á€±á€·á€”á€­á€¯á€„á€ºá€á€Šá€º)
  const PAYOUT_EXACT_DIGIT = 5; // bet_amount * 5 (á€‚á€á€”á€ºá€¸ á… á€™á€¾á€œá€½á€²á)
  const PAYOUT_DIGIT_5 = 10;    // bet_amount * 10 (á€‚á€á€”á€ºá€¸ á… á€¡á€á€½á€€á€º)

  // á€œá€¾á€Šá€·á€ºá€á€¼á€„á€ºá€¸á€œá€¯á€•á€ºá€„á€”á€ºá€¸á€…á€‰á€ºá€€á€­á€¯ á€€á€­á€¯á€„á€ºá€á€½á€šá€ºá€á€±á€¬ Function
  const handleSpin = async () => {
    // á€¡á€á€¼á€±á€á€¶ á€…á€…á€ºá€†á€±á€¸á€™á€¾á€¯á€™á€»á€¬á€¸
    if (selectedDigit === null) {
      setMessage('á€œá€±á€¬á€„á€ºá€¸á€›á€”á€º á€‚á€á€”á€ºá€¸á€á€…á€ºá€á€¯á€€á€­á€¯ á€›á€½á€±á€¸á€á€»á€šá€ºá€•á€±á€¸á€•á€«!');
      return;
    }
    if (betAmount <= 0) {
      setMessage('á€œá€±á€¬á€„á€ºá€¸á€€á€¼á€±á€¸á€•á€™á€¬á€á€á€Šá€º á€á€¯á€Šá€‘á€€á€º á€€á€¼á€®á€¸á€›á€™á€Šá€º!');
      return;
    }
    if (betAmount > walletBalance) {
      setMessage('á€œá€€á€ºá€€á€»á€”á€ºá€„á€½á€± á€™á€œá€¯á€¶á€œá€±á€¬á€€á€ºá€•á€«! á€œá€±á€¬á€„á€ºá€¸á€€á€¼á€±á€¸á€œá€»á€¾á€±á€¬á€·á€á€»á€•á€±á€¸á€•á€«.');
      return;
    }

    // á€™á€€á€ºá€†á€±á€·á€á€»á€ºá€™á€»á€¬á€¸á€”á€¾á€„á€·á€º á€›á€œá€’á€ºá€™á€»á€¬á€¸á€€á€­á€¯ á€•á€¼á€”á€ºá€œá€Šá€ºá€á€á€ºá€™á€¾á€á€ºá€á€Šá€º
    setMessage('');
    setResultDigit(null);
    setIsSpinning(true);
    setSpinAnimationDigit(null);

    // á€œá€¾á€Šá€·á€ºá€á€±á€¬ Animation á€€á€­á€¯ á€…á€á€„á€ºá€á€Šá€º
    let animationCount = 0;
    spinIntervalRef.current = setInterval(() => {
      setSpinAnimationDigit(Math.floor(Math.random() * 10)); // á€€á€»á€•á€”á€ºá€¸á€‚á€á€”á€ºá€¸á€™á€»á€¬á€¸ á€œá€¾á€Šá€·á€ºá€”á€±á€…á€±á€á€Šá€º
      animationCount++;
    }, 100); // á€‚á€á€”á€ºá€¸á€á€­á€¯á€„á€ºá€¸á€€á€­á€¯ 100ms á€á€…á€ºá€á€« á€•á€¼á€±á€¬á€„á€ºá€¸á€œá€²á€á€Šá€º

    // Animation á€…á€á€„á€ºá€•á€¼á€®á€¸á€”á€±á€¬á€€á€º Backend API á€á€±á€«á€ºá€†á€­á€¯á€™á€¾á€¯á€€á€­á€¯ á€¡á€á€¯á€šá€°á€á€Šá€º (á€á€­á€¯á€á€±á€¬á€„á€ºá€¸á€á€±á€¬ á€”á€¾á€±á€¬á€„á€·á€ºá€”á€¾á€±á€¸á€™á€¾á€¯á€–á€¼á€„á€·á€º)
    setTimeout(async () => {
      clearInterval(spinIntervalRef.current); // á€œá€¾á€Šá€·á€ºá€á€¼á€„á€ºá€¸á€€á€­á€¯ á€›á€•á€ºá€á€Šá€º
      setIsSpinning(false); // á€œá€¾á€Šá€·á€ºá€á€±á€¬ Animation UI á€€á€­á€¯ á€›á€•á€ºá€á€Šá€º

      try {
        // Backend API á€á€±á€«á€ºá€†á€­á€¯á€™á€¾á€¯á€€á€­á€¯ á€¡á€á€¯á€šá€°á€á€Šá€º
        const apiResponse = await simulateBackendSpin(selectedDigit, betAmount);

        if (apiResponse.success) {
          setResultDigit(apiResponse.data.rolledNumber);
          setWalletBalance(apiResponse.data.newBalance);
          setMessage(apiResponse.message);
        } else {
          setMessage(apiResponse.message);
          setWalletBalance(apiResponse.data?.newBalance || walletBalance); // Backend á€¡á€™á€¾á€¬á€¸á€›á€¾á€­á€œá€»á€¾á€„á€ºá€•á€„á€º á€œá€€á€ºá€€á€»á€”á€ºá€„á€½á€±á€€á€­á€¯ á€•á€¼á€”á€ºá€œá€Šá€ºá€á€á€ºá€™á€¾á€á€ºá€á€Šá€º
        }
      } catch (error) {
        console.error('Spin á€œá€¯á€•á€ºá€†á€±á€¬á€„á€ºá€”á€±á€…á€‰á€º Frontend á€¡á€™á€¾á€¬á€¸:', error);
        setMessage('á€œá€¾á€Šá€·á€ºá€”á€±á€…á€‰á€º á€¡á€™á€¾á€¬á€¸á€á€…á€ºá€á€¯ á€–á€¼á€…á€ºá€•á€±á€«á€ºá€á€²á€·á€á€Šá€ºá‹ á€€á€»á€±á€¸á€‡á€°á€¸á€•á€¼á€¯á á€‘á€•á€ºá€™á€¶á€€á€¼á€­á€¯á€¸á€…á€¬á€¸á€•á€«á‹');
      } finally {
        setSpinAnimationDigit(null); // Animation á€•á€¼á€®á€¸á€†á€¯á€¶á€¸á€•á€«á€€ á€‚á€á€”á€ºá€¸á€€á€­á€¯ á€–á€»á€€á€ºá€á€Šá€º
      }
    }, 2500); // 2.5 á€…á€€á€¹á€€á€”á€·á€ºá€€á€¼á€¬ á€œá€¾á€Šá€·á€ºá€á€Šá€º (100ms interval á€–á€¼á€„á€·á€º 25 á€€á€¼á€­á€™á€º á€•á€¼á€±á€¬á€„á€ºá€¸á€œá€²á€á€Šá€º)
  };

  // Backend API á€á€±á€«á€ºá€†á€­á€¯á€™á€¾á€¯á€€á€­á€¯ á€¡á€á€¯á€šá€°á€á€±á€¬ Function
  const simulateBackendSpin = async (betDigit, currentBetAmount) => {
    // á€œá€€á€ºá€á€½á€±á€· Application á€á€½á€„á€º áá€„á€ºá€¸á€€á€­á€¯ á€á€„á€ºá Laravel API á€á€­á€¯á€· á€•á€±á€¸á€•á€­á€¯á€·á€›á€™á€Šá€º:
    // const response = await fetch('/api/spin', { method: 'POST', body: JSON.stringify({ betDigit, betAmount: currentBetAmount }) });
    // const data = await response.json();
    // return data;

    // Network á€”á€¾á€±á€¬á€„á€·á€ºá€”á€¾á€±á€¸á€™á€¾á€¯á€€á€­á€¯ á€¡á€á€¯á€šá€°á€á€Šá€º
    await new Promise(resolve => setTimeout(resolve, 500)); // Network á€¡á€á€½á€€á€º 0.5 á€…á€€á€¹á€€á€”á€·á€º á€‘á€•á€ºá€†á€±á€¬á€„á€ºá€¸á€á€Šá€º

    const rolledNumber = Math.floor(Math.random() * 10);
    let winStatus;
    let winAmount = 0;

    // á€¡á€”á€­á€¯á€„á€º/á€¡á€›á€¾á€¯á€¶á€¸á€€á€­á€¯ á€†á€¯á€¶á€¸á€–á€¼á€á€ºá€•á€¼á€®á€¸ á€¡á€”á€­á€¯á€„á€ºá€›á€„á€½á€±á€€á€­á€¯ á€á€½á€€á€ºá€á€»á€€á€ºá€á€Šá€º
    if (betDigit === rolledNumber) {
      winStatus = 'win';
      // á€á€®á€¸á€á€¼á€¬á€¸ Payout á€…á€Šá€ºá€¸á€™á€»á€‰á€ºá€¸á€™á€»á€¬á€¸
      if (rolledNumber === 5) {
        winAmount = currentBetAmount * PAYOUT_DIGIT_5;
      } else {
        winAmount = currentBetAmount * PAYOUT_EXACT_DIGIT;
      }
    } else {
      winStatus = 'lose';
      winAmount = 0; // á€›á€¾á€¯á€¶á€¸á€œá€»á€¾á€„á€º á€¡á€”á€­á€¯á€„á€ºá€›á€„á€½á€± á€™á€›á€¾á€­á€•á€«
    }

    const newBalance = winStatus === 'win'
      ? walletBalance - currentBetAmount + winAmount
      : walletBalance - currentBetAmount;

    return {
      success: true,
      message: winStatus === 'win' ?
        `á€á€„á€ºá€”á€­á€¯á€„á€ºá€•á€«á€á€Šá€º! á€‚á€á€”á€ºá€¸á€™á€¾á€¬ ${rolledNumber} á€–á€¼á€…á€ºá€•á€«á€á€Šá€º! á€á€„á€º ${winAmount} á€¡á€”á€­á€¯á€„á€ºá€›á€›á€¾á€­á€á€²á€·á€•á€«á€á€Šá€º!` :
        `á€á€„á€ºá€›á€¾á€¯á€¶á€¸á€•á€«á€á€Šá€º! á€‚á€á€”á€ºá€¸á€™á€¾á€¬ ${rolledNumber} á€–á€¼á€…á€ºá€•á€«á€á€Šá€º.`,
      data: {
        rolledNumber,
        winStatus,
        winAmount,
        newBalance
      }
    };
  };

  // Component á€™á€–á€»á€€á€ºá€™á€® Interval á€€á€­á€¯ á€›á€¾á€„á€ºá€¸á€œá€„á€ºá€¸á€á€Šá€º
  useEffect(() => {
    return () => {
      if (spinIntervalRef.current) {
        clearInterval(spinIntervalRef.current);
      }
    };
  }, []);

  return (
    <div className="p-8 rounded-2xl w-full text-center"> {/* á€¡á€•á€­á€¯ Style á€–á€šá€ºá€›á€¾á€¬á€¸á€•á€¼á€®á€¸ Central Alignment á€€á€­á€¯ á€‘á€­á€”á€ºá€¸á€‘á€¬á€¸á€á€Šá€º */}
      <h1 className="text-4xl font-bold text-teal-400 mb-6 drop-shadow-lg">
        ğŸ° One-Digit Slot
      </h1>

      {/* Wallet Balance */}
      <div className="mb-6 p-4 bg-gray-700 rounded-xl shadow-inner border border-gray-600">
        <p className="text-xl text-gray-300 mb-1">á€á€„á€ºá á€œá€€á€ºá€€á€»á€”á€ºá€„á€½á€±</p>
        <p className="text-4xl font-extrabold text-white">
          ${walletBalance.toFixed(2)}
        </p>
      </div>

      {/* Digit Spinner Display */}
      <div className="mb-8 p-6 bg-gray-900 rounded-xl shadow-2xl flex items-center justify-center h-40 border border-gray-600 relative overflow-hidden">
        {isSpinning ? (
          <div className="text-8xl font-extrabold text-yellow-400 animate-pulse transition-transform duration-75 ease-in-out">
            {spinAnimationDigit !== null ? spinAnimationDigit : '?'}
          </div>
        ) : (
          <div className="text-8xl font-extrabold text-green-400 animate-fade-in">
            {resultDigit !== null ? resultDigit : '?'}
          </div>
        )}
        {/* Visual Effect á€¡á€á€½á€€á€º Simple Overlay */}
        <div className="absolute inset-0 bg-gradient-to-t from-transparent via-gray-900/50 to-transparent pointer-events-none"></div>
      </div>

      {/* Bet Amount Input */}
      <div className="mb-6">
        <label htmlFor="bet-amount" className="block text-gray-300 text-lg font-semibold mb-2">
          á€œá€±á€¬á€„á€ºá€¸á€€á€¼á€±á€¸á€•á€™á€¬á€:
        </label>
        <input
          id="bet-amount"
          type="number"
          min="1"
          value={betAmount}
          onChange={(e) => setBetAmount(Math.max(1, parseInt(e.target.value) || 0))}
          className="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:ring-2 focus:ring-teal-500 focus:border-transparent text-xl text-center"
          disabled={isSpinning}
        />
      </div>

      {/* Digit Selection Buttons */}
      <div className="mb-8">
        <h2 className="text-xl font-semibold text-gray-300 mb-3">á€á€„á€ºá á€€á€¶á€€á€±á€¬á€„á€ºá€¸á€á€±á€¬ á€‚á€á€”á€ºá€¸á€€á€­á€¯ á€›á€½á€±á€¸á€á€»á€šá€ºá€•á€«</h2>
        <div className="grid grid-cols-5 gap-3">
          {[0, 1, 2, 3, 4, 5, 6, 7, 8, 9].map((digit) => (
            <button
              key={digit}
              onClick={() => setSelectedDigit(digit)}
              className={`
                p-4 rounded-lg font-bold text-xl transition-all duration-200 shadow-md
                ${selectedDigit === digit
                  ? 'bg-teal-600 text-white ring-4 ring-teal-300 scale-105'
                  : 'bg-gray-700 text-gray-200 hover:bg-teal-500 hover:text-white border border-gray-600'
                }
                ${isSpinning ? 'opacity-50 cursor-not-allowed' : ''}
              `}
              disabled={isSpinning}
            >
              {digit}
            </button>
          ))}
        </div>
      </div>

      {/* Spin Button */}
      <button
        onClick={handleSpin}
        className="w-full bg-gradient-to-r from-teal-500 to-blue-600 hover:from-teal-600 hover:to-blue-700 text-white py-4 rounded-xl text-2xl font-bold transition-all duration-300 shadow-lg flex items-center justify-center gap-3
                   transform hover:-translate-y-1 active:translate-y-0 active:scale-98 focus:outline-none focus:ring-4 focus:ring-teal-400"
        disabled={isSpinning || selectedDigit === null || betAmount <= 0}
      >
        {isSpinning ? (
          <>
            <svg className="animate-spin h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
              <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            á€œá€¾á€Šá€·á€ºá€”á€±á€á€Šá€º...
          </>
        ) : (
          'Slot á€€á€­á€¯ á€œá€¾á€Šá€·á€ºá€™á€Šá€º!'
        )}
      </button>

      {/* Messages Display */}
      {message && (
        <p className={`mt-6 text-lg font-semibold p-4 rounded-xl shadow-md animate-fade-in
          ${message.includes('WON') ? 'bg-green-700 text-green-100 border border-green-600' :
            message.includes('LOST') ? 'bg-red-700 text-red-100 border border-red-600' :
            'bg-blue-700 text-blue-100 border border-blue-600'}
        `}>
          {message}
        </p>
      )}

      {/* Current Bet Status */}
      <div className="mt-8 text-sm text-gray-400">
        <p className="mb-2">
          <strong>á€œá€€á€ºá€›á€¾á€­ á€œá€±á€¬á€„á€ºá€¸á€€á€¼á€±á€¸:</strong> {selectedDigit !== null ? `á€‚á€á€”á€ºá€¸ ${selectedDigit}` : 'á€™á€›á€¾á€­á€á€±á€¸á€•á€«'}
        </p>
        <p>
          á€á€„á€ºá á€œá€±á€¬á€„á€ºá€¸á€€á€¼á€±á€¸á€•á€™á€¬á€á€€á€­á€¯ á€‘á€Šá€·á€ºá€•á€¼á€®á€¸ á€‚á€á€”á€ºá€¸ (0-9) á€á€…á€ºá€á€¯á€€á€­á€¯ á€›á€½á€±á€¸á€á€»á€šá€ºá€•á€«áŠ á€‘á€­á€¯á€·á€”á€±á€¬á€€á€º "Slot á€€á€­á€¯ á€œá€¾á€Šá€·á€ºá€™á€Šá€º!" á€€á€­á€¯ á€”á€¾á€­á€•á€ºá€•á€«á‹
        </p>
      </div>
    </div>
  );
}

export default SlotRell;